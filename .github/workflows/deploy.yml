# name: Deploy to EC2
# env:
#   AWS_DEFAULT_REGION: ap-northeast-2

# on:
#   push:
#     branches: [master]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Install SSH key
#         run: |
#           echo "${{ secrets.EC2_PEM_KEY }}" | tr -d '\r' > bohumstore.pem
#           chmod 400 bohumstore.pem

#       - name: Verify SSH key creation
#         run: ls -l bohumstore.pem

#       - name: Deploy to EC2
#         run: |
#           ssh -i bohumstore.pem -o StrictHostKeyChecking=no ubuntu@3.37.112.222 'cd bohumstore && git pull && npm install && npm run build && pm2 restart bohumstore'


name: Deploy to EC2 (GitHub Build)

on:
  push:
    branches:
      - master

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create production environment
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://ttbwyuenbcsvnixvlaxi.supabase.co" > .env.production
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0Ynd5dWVuYmNzdm5peHZsYXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTQ5NDYsImV4cCI6MjA2NjQ5MDk0Nn0.e0eCn67ol3n3RMRlEKPNgfXipmfe84bYFORuvrO0vYQ" >> .env.production
          echo "ALIGO_API_KEY=sikjbqg1q2b28ypkiwu16s96v35ax3ws" >> .env.production
          echo "ALIGO_SENDER_KEY=26efd14d29bc820796c85a6fa84102e4d3cd0e1c" >> .env.production
          echo "ALIGO_USER_ID=urisky1" >> .env.production
          echo "NEXT_PUBLIC_KAKAO_REST_API_KEY=132e4aea952cb67e1824b97ed215fbb8" >> .env.production
          echo "NEXT_PUBLIC_KAKAO_ADMIN_KEY=6c384b1fb375be4acd649ee4d1aa4285" >> .env.production

      - name: Build Next.js
        run: |
          npm uninstall lightningcss @tailwindcss/node @tailwindcss/postcss --silent || true
          npm install @tailwindcss/postcss --silent
          NODE_ENV=production npm run build

      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz .next node_modules/next package.json package-lock.json .env.production public

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment.tar.gz
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Write SSH key
        run: |
          echo "${{ secrets.EC2_PEM_KEY }}" > ec2.pem
          chmod 400 ec2.pem

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_PATH: ${{ secrets.EC2_PATH }}
          PM2_APP: ${{ secrets.PM2_APP }}
        run: |
          # EC2ì— ë°°í¬ íŒ¨í‚¤ì§€ ì „ì†¡
          scp -o StrictHostKeyChecking=no -i ec2.pem deployment.tar.gz "${EC2_USER}@${EC2_HOST}:/tmp/"
          
          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i ec2.pem "${EC2_USER}@${EC2_HOST}" <<EOF
            set -e
            
            # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi
            
            # Nginx ì„¤ì¹˜ ë° ì„¤ì • (ì™„ì „ ì´ˆê¸°í™”)
            if ! command -v nginx >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # ë¨¼ì € ê¸°ë³¸ HTTP Nginx ì„¤ì •
            echo "âœ… ê¸°ë³¸ HTTP Nginx ì„¤ì •"
            sudo rm -rf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
            echo "server { listen 80; server_name bohumstore.net; location / { proxy_pass http://localhost:3000; } }" | sudo tee /etc/nginx/sites-available/default
            sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
            sudo systemctl start nginx
            
            # Certbotìœ¼ë¡œ ìë™ HTTPS ì„¤ì • (ë³€ìˆ˜ ì´ìŠ¤ì¼€ì´í•‘ ë¬¸ì œ ì—†ìŒ)
            echo "âœ… Certbot ìë™ HTTPS ì„¤ì • ì‹œì‘"
            sudo apt-get install -y certbot python3-certbot-nginx
            sudo certbot --nginx -d bohumstore.net --non-interactive --agree-tos --email admin@bohumstore.net --redirect || echo "HTTPS ìë™ ì„¤ì • ì‹¤íŒ¨"
            sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
            sudo systemctl enable nginx
            
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p "${EC2_PATH}"
            cd "${EC2_PATH}"
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—… ë° ì •ë¦¬
            if [ -f "deployment.tar.gz.old" ]; then
              rm -f deployment.tar.gz.old
            fi
            if [ -f "deployment.tar.gz" ]; then
              mv deployment.tar.gz deployment.tar.gz.old
            fi
            
            # ìƒˆ ë°°í¬ íŒŒì¼ ì´ë™ ë° ì••ì¶• í•´ì œ
            mv /tmp/deployment.tar.gz .
            tar -xzf deployment.tar.gz
            
            # ì¢…ì†ì„± ì¬ì„¤ì¹˜ (ëª¨ë“ˆ ì—ëŸ¬ ë°©ì§€)
            echo "=== ì¢…ì†ì„± ì¬ì„¤ì¹˜ ==="
            npm install --production
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
            APP_NAME="${PM2_APP:-bohumstore}"
            
            if pm2 describe "\$APP_NAME" >/dev/null 2>&1; then
              pm2 delete "\$APP_NAME"
            fi
            
            pm2 start node_modules/next/dist/bin/next --name "\$APP_NAME" -- start -H 0.0.0.0
            pm2 save
            
            # ë””ë²„ê¹…: PM2 ìƒíƒœ í™•ì¸
            echo "=== PM2 ìƒíƒœ í™•ì¸ ==="
            pm2 status
            pm2 logs "\$APP_NAME" --lines 10 --nostream || true
            
            # ë””ë²„ê¹…: í¬íŠ¸ ìƒíƒœ í™•ì¸  
            echo "=== í¬íŠ¸ 3000 ìƒíƒœ í™•ì¸ ==="
            sudo netstat -tlnp | grep :3000 || echo "í¬íŠ¸ 3000 ì‚¬ìš© ì—†ìŒ"
            
            # ë””ë²„ê¹…: Next.js í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "=== Next.js í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
            ps aux | grep next || echo "Next.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # ë””ë²„ê¹…: localhost:3000 í…ŒìŠ¤íŠ¸
            echo "=== localhost:3000 ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
            curl -I http://localhost:3000 || echo "localhost:3000 ì—°ê²° ì‹¤íŒ¨"
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘
            echo "=== Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ==="
            sudo nginx -t
            if [ \$? -eq 0 ]; then
              echo "âœ… Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ì„±ê³µ"
              sudo systemctl restart nginx
              sudo systemctl status nginx --no-pager -l
              echo "âœ… Nginx HTTPS ì¤€ë¹„ ì™„ë£Œ"
              echo "ğŸ“‹ í™•ì¸ í•„ìš”: AWS ë³´ì•ˆê·¸ë£¹ì—ì„œ 443 í¬íŠ¸(HTTPS) ì—´ì–´ì•¼ í•¨"
            else
              echo "âš ï¸  Nginx ì„¤ì • ì˜¤ë¥˜ - HTTPë§Œ ì‚¬ìš©"
              echo "server { listen 80; location / { proxy_pass http://localhost:3000; } }" | sudo tee /etc/nginx/sites-available/default
              sudo systemctl restart nginx
            fi
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF
