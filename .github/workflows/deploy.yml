# name: Deploy to EC2
# env:
#   AWS_DEFAULT_REGION: ap-northeast-2

# on:
#   push:
#     branches: [master]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Install SSH key
#         run: |
#           echo "${{ secrets.EC2_PEM_KEY }}" | tr -d '\r' > bohumstore.pem
#           chmod 400 bohumstore.pem

#       - name: Verify SSH key creation
#         run: ls -l bohumstore.pem

#       - name: Deploy to EC2
#         run: |
#           ssh -i bohumstore.pem -o StrictHostKeyChecking=no ubuntu@3.37.112.222 'cd bohumstore && git pull && npm install && npm run build && pm2 restart bohumstore'


name: Deploy to EC2 (GitHub Build)

on:
  push:
    branches:
      - master

concurrency:
  group: deploy-ec2
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create production environment
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=https://ttbwyuenbcsvnixvlaxi.supabase.co" > .env.production
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0Ynd5dWVuYmNzdm5peHZsYXhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTQ5NDYsImV4cCI6MjA2NjQ5MDk0Nn0.e0eCn67ol3n3RMRlEKPNgfXipmfe84bYFORuvrO0vYQ" >> .env.production
          echo "ALIGO_API_KEY=sikjbqg1q2b28ypkiwu16s96v35ax3ws" >> .env.production
          echo "ALIGO_SENDER_KEY=26efd14d29bc820796c85a6fa84102e4d3cd0e1c" >> .env.production
          echo "ALIGO_USER_ID=urisky1" >> .env.production
          echo "NEXT_PUBLIC_KAKAO_REST_API_KEY=132e4aea952cb67e1824b97ed215fbb8" >> .env.production
          echo "NEXT_PUBLIC_KAKAO_ADMIN_KEY=6c384b1fb375be4acd649ee4d1aa4285" >> .env.production

      - name: Build Next.js
        run: |
          npm uninstall lightningcss @tailwindcss/node @tailwindcss/postcss --silent || true
          npm install @tailwindcss/postcss --silent
          NODE_ENV=production npm run build

      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz .next node_modules/next package.json package-lock.json .env.production

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment.tar.gz
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Write SSH key
        run: |
          echo "${{ secrets.EC2_PEM_KEY }}" > ec2.pem
          chmod 400 ec2.pem

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_PATH: ${{ secrets.EC2_PATH }}
          PM2_APP: ${{ secrets.PM2_APP }}
        run: |
          # EC2에 배포 패키지 전송
          scp -o StrictHostKeyChecking=no -i ec2.pem deployment.tar.gz "${EC2_USER}@${EC2_HOST}:/tmp/"
          
          # EC2에서 배포 실행
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i ec2.pem "${EC2_USER}@${EC2_HOST}" <<EOF
            set -e
            
            # 필수 패키지 설치
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm install -g pm2
            fi
            
            # Nginx 설치 및 설정 (완전 초기화)
            if ! command -v nginx >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # Nginx 완전 초기화 및 최소 설정
            sudo systemctl stop nginx || true
            sudo rm -rf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
            echo "server { listen 80; location / { proxy_pass http://localhost:3000; } }" | sudo tee /etc/nginx/sites-available/default
            sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
            sudo systemctl enable nginx
            
            # 배포 디렉토리 준비
            mkdir -p "${EC2_PATH}"
            cd "${EC2_PATH}"
            
            # 기존 파일 백업 및 정리
            if [ -f "deployment.tar.gz.old" ]; then
              rm -f deployment.tar.gz.old
            fi
            if [ -f "deployment.tar.gz" ]; then
              mv deployment.tar.gz deployment.tar.gz.old
            fi
            
            # 새 배포 파일 이동 및 압축 해제
            mv /tmp/deployment.tar.gz .
            tar -xzf deployment.tar.gz
            
            # PM2로 애플리케이션 재시작
            APP_NAME="${PM2_APP:-bohumstore}"
            
            if pm2 describe "\$APP_NAME" >/dev/null 2>&1; then
              pm2 delete "\$APP_NAME"
            fi
            
            pm2 start node_modules/next/dist/bin/next --name "\$APP_NAME" -- start -H 0.0.0.0
            pm2 save
            
            # 디버깅: PM2 상태 확인
            echo "=== PM2 상태 확인 ==="
            pm2 status
            pm2 logs "\$APP_NAME" --lines 10 --nostream || true
            
            # 디버깅: 포트 상태 확인  
            echo "=== 포트 3000 상태 확인 ==="
            sudo netstat -tlnp | grep :3000 || echo "포트 3000 사용 없음"
            
            # 디버깅: Next.js 프로세스 확인
            echo "=== Next.js 프로세스 확인 ==="
            ps aux | grep next || echo "Next.js 프로세스 없음"
            
            # 디버깅: localhost:3000 테스트
            echo "=== localhost:3000 연결 테스트 ==="
            curl -I http://localhost:3000 || echo "localhost:3000 연결 실패"
            
            # Nginx 재시작 (80번 포트용)
            sudo nginx -t
            if [ \$? -eq 0 ]; then
              sudo systemctl restart nginx
              echo "✅ Nginx 80번 포트 준비 완료"
            else
              echo "⚠️  Nginx 설정 오류, 3000번 포트만 사용"
            fi
            
            echo "✅ 배포 완료!"
          EOF
